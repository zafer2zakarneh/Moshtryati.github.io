<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ ğŸ›’</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Noto Naskh Arabic', serif; direction: rtl; text-align: center; background: #f9f9f9; margin:0; padding:20px; }
  h2 { margin: 10px; font-size: 26px; }
  .topBar { width: 90%; margin: 0 auto 12px auto; display:flex; justify-content:flex-end; gap:12px; align-items:center; }
  .box { min-width:80px; padding:8px 10px; border-radius:8px; background:#fff; box-shadow:0 0 6px rgba(0,0,0,0.08); border:1px solid #e6e6e6; font-size:14px; }
  .balanceTop { font-weight:700; padding:8px 12px; border-radius:8px; background:#fff; box-shadow:0 0 6px rgba(0,0,0,0.08); border:1px solid #e6e6e6; min-width:120px; text-align:center;}
  table { width: 90%; margin: 10px auto 30px auto; border-collapse: collapse; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 16px; }
  th { background-color: #f1f1f1; }
  tfoot td { font-weight: bold; background: #fafafa; }
  input.itemInput { width: 95%; padding: 5px; font-size: 15px; font-family: inherit; text-align: center; box-sizing: border-box; }
  button { padding: 6px 14px; margin: 10px; font-size: 15px; border: none; border-radius: 5px; cursor: pointer; }
  .btn { background: #007AFF; color: white; }
  .btn:hover { background: #005BB5; }
  .strike td { text-decoration: line-through; color: gray; }
  .strike input { text-decoration: line-through; color: gray; }
  .toggleBtn { cursor: pointer; font-size: 18px; user-select:none; }
  .total { min-width:80px; }
  @media print {
    .topBar, .btn { display:none !important; }
  }
</style>
</head>
<body>

<h2>Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ ğŸ›’</h2>

<!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±ØµÙŠØ¯: ØµÙ†Ø¯ÙˆÙ‚Ø§Ù† + Ø±ØµÙŠØ¯ -->
<div id="topBoxes" class="topBar" style="display:none;">
  <div class="box">ØµÙ†Ø¯ÙˆÙ‚ 2</div>
  <div class="box">ØµÙ†Ø¯ÙˆÙ‚ 1</div>
  <div id="balanceTop" class="balanceTop">Ø§Ù„Ø±ØµÙŠØ¯: 0.00 Ø´</div>
</div>

<div style="margin-bottom:8px;">
  <button class="btn" onclick="addBalance()">+ Ø±ØµÙŠØ¯</button>
  <button class="btn" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
</div>

<table id="billTable">
  <thead>
    <tr>
      <th>âœ”ï¸</th>
      <th>Ø§Ù„ØµÙ†Ù</th>
      <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
      <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (Ø´)</th>
      <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø´)</th>
    </tr>
  </thead>
  <tbody id="billBody">
    <tr>
      <td class="toggleBtn" onclick="toggleStrike(this)">â­•</td>
      <td><input type="text" class="itemInput" placeholder="Ù…Ø«Ø§Ù„: 6 Ø´Ù…Ø§Ù… 5Ø´" onkeydown="handleEnter(event,this)"></td>
      <td><input type="number" class="itemInput qtyInput" value="0" disabled></td>
      <td><input type="number" class="itemInput priceInput" value="0" step="0.01" disabled></td>
      <td class="total">0.00</td>
    </tr>
  </tbody>
  <tfoot>
    <tr id="balanceRow" style="display:none;">
      <td colspan="4">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</td>
      <td id="balanceValue">0.00</td>
    </tr>
    <tr>
      <td colspan="4">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</td>
      <td id="grandTotal">0.00</td>
    </tr>
  </tfoot>
</table>

<script>
let customerBalance = null;
let lastSpaceTime = 0;

// Ù†Ø³ØªØ®Ø¯Ù… debounce 2 Ø«Ø§Ù†ÙŠØ© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±
const DEBOUNCE_MS = 2000;

// Ø¹Ù†Ø¯ Ø§Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ/Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ù†Ø¶ÙŠÙ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø­Ø¯Ø« Ù„Ù„Ø­Ù‚Ù„ÙŠÙ† qty Ùˆ price
function attachInputListeners(row){
  const qtyInput = row.querySelector(".qtyInput");
  const priceInput = row.querySelector(".priceInput");

  function scheduleUpdate(){
    // Ø­ÙØ¸ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ù†ÙØ³Ù‡
    if(row._updateTimer) clearTimeout(row._updateTimer);
    row._updateTimer = setTimeout(()=>{
      recomputeRowFromInputs(row);
      updateGrandTotal();
      row._updateTimer = null;
    }, DEBOUNCE_MS);
  }

  // Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù†Ø¤Ø¬Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
  qtyInput.addEventListener("input", scheduleUpdate);
  priceInput.addEventListener("input", scheduleUpdate);
}

// ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙ Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
function recomputeRowFromInputs(row){
  const qty = parseFloat(row.querySelector(".qtyInput").value) || 0;
  const price = parseFloat(row.querySelector(".priceInput").value) || 0;
  const totalCell = row.querySelector(".total");
  const newTotal = qty * price;
  totalCell.textContent = newTotal.toFixed(2);
}

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Enter Ø£Ùˆ Space: ØªÙÙƒÙŠÙƒ Ø§Ù„Ù†Øµ
function handleEnter(e, input){
  if(e.key === "Enter" || e.key === " "){
    let now = Date.now();
    if(e.key === " "){
      if(now - lastSpaceTime < 500){ // Ø¶ØºØ·ØªÙŠÙ† Space => Ø§Ø¶Ù ØµÙ
        parseItem(input);
        addRow();
      } else {
        parseItem(input); // Ø¶ØºØ·Ø© ÙˆØ­Ø¯Ø© = Ø­Ø³Ø§Ø¨ ÙÙ‚Ø·
      }
      lastSpaceTime = now;
    } else if(e.key === "Enter"){
      parseItem(input);
      addRow();
    }
    e.preventDefault();
  }
}

function parseItem(input){
  let text = input.value.trim();
  let row = input.closest("tr");
  let cells = row.querySelectorAll("td");

  let qty = 1, price = 0, name = text;

  let qtyMatch = text.match(/^(\d+)\s+/);
  if(qtyMatch){ qty = parseFloat(qtyMatch[1]); name = text.replace(qtyMatch[0],''); }

  let priceMatch = text.match(/([\d\.]+)\s*Ø´/);
  if(priceMatch){ price = parseFloat(priceMatch[1]); name = name.replace(priceMatch[0],''); }

  // Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù
  cells[1].querySelector("input").value = name.trim();
  let qtyInput = cells[2].querySelector("input");
  let priceInput = cells[3].querySelector("input");

  qtyInput.value = qty;
  priceInput.value = price.toFixed(2);

  let total = qty * price;
  cells[4].textContent = total.toFixed(2);

  // Ù‚ÙÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø«Ù… ÙØªØ­Ù‡Ø§ (ÙƒÙ…Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯)
  qtyInput.disabled = true;
  priceInput.disabled = true;
  setTimeout(()=>{
    qtyInput.disabled = false;
    priceInput.disabled = false;
  },2000);

  // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ù„Ø¯ÙŠÙ‡ Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
  attachInputListeners(row);

  updateGrandTotal();
}

function addRow(){
  let tbody = document.getElementById("billBody");
  let newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td class="toggleBtn" onclick="toggleStrike(this)">â­•</td>
    <td><input type="text" class="itemInput" placeholder="Ø§ÙƒØªØ¨ ØµÙ†Ù..." onkeydown="handleEnter(event,this)"></td>
    <td><input type="number" class="itemInput qtyInput" value="0" disabled></td>
    <td><input type="number" class="itemInput priceInput" value="0" step="0.01" disabled></td>
    <td class="total">0.00</td>
  `;
  tbody.appendChild(newRow);

  // Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„ØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  attachInputListeners(newRow);

  // ÙÙˆÙƒØ³ Ù„Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯
  newRow.querySelector("input[type=text]").focus();
}

function toggleStrike(btn){
  let row = btn.closest("tr");
  row.classList.toggle("strike");
  updateGrandTotal();
}

function updateGrandTotal(){
  let rows = document.querySelectorAll("#billBody tr");
  let sum = 0;
  rows.forEach(r=>{
    if(!r.classList.contains("strike")){
      sum += parseFloat(r.querySelector(".total").textContent) || 0;
    }
  });
  document.getElementById("grandTotal").textContent = sum.toFixed(2);

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±ØµÙŠØ¯ Ø²Ø¨ÙˆÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù„ÙˆÙŠ
  if(customerBalance !== null){
    let remain = customerBalance - sum;
    let balanceCell = document.getElementById("balanceValue");
    let balanceTopCell = document.getElementById("balanceTop");

    balanceCell.textContent = remain.toFixed(2);
    balanceCell.style.color = remain >= 0 ? "green" : "red";

    // ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    balanceTopCell.textContent = `Ø§Ù„Ø±ØµÙŠØ¯: ${customerBalance.toFixed(2)} Ø´ â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remain.toFixed(2)} Ø´`;
    balanceTopCell.style.color = remain >= 0 ? "green" : "red";

    if(remain === 0){ balanceCell.textContent += " âœ”ï¸"; }
  }
}

function addBalance(){
  let amount = prompt("Ø£Ø¯Ø®Ù„ Ø±ØµÙŠØ¯ Ø§Ù„Ø²Ø¨ÙˆÙ† (Ø´ÙŠÙƒÙ„):");
  if(amount !== null && amount !== "" && !isNaN(amount)){
    customerBalance = parseFloat(amount);
    // Ø¥Ø¸Ù‡Ø§Ø± Ø³Ø·Ø± Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Footer
    document.getElementById("balanceRow").style.display = "table-row";
    // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© ÙÙŠÙ‡ ØµÙ†Ø¯ÙˆÙ‚Ø§Ù† + Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±ØµÙŠØ¯
    document.getElementById("topBoxes").style.display = "flex";
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© ÙÙˆØ±Ø§Ù‹
    document.getElementById("balanceTop").textContent = `Ø§Ù„Ø±ØµÙŠØ¯: ${customerBalance.toFixed(2)} Ø´`;
    updateGrandTotal();
  }
}

// Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„: Ø±Ø¨Ø· Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ÙˆÙ„
document.addEventListener("DOMContentLoaded", ()=>{
  const firstRow = document.querySelector("#billBody tr");
  attachInputListeners(firstRow);
});
</script>

</body>
</html>