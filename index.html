<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª â€” ÙˆØ±Ø¯ÙŠ Ù†Ù‡Ø§Ø¦ÙŠ ğŸŒ¸</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fff6fb;
  --card:#ffffff;
  --rose-1:#ff8fb0;
  --rose-2:#ff5a87;
  --muted:#8a7a86;
  --shadow: 0 10px 30px rgba(255,90,130,0.08);
  --radius:14px;
  --sea-blue:#025b8a;
  --desert-yellow:#d6a60f;
  --grass-green:#3a9a40;
  --rose-red:#d63b4a;
  --copper-orange:#cc6b2f;
  --haft-silver:#bfc5cc;
  --gray:#9b9b9b;
  --pale-gray:#dcdcdc;
  --antique-copper:#7a3b2b;
}
*{box-sizing:border-box;font-family:'Cairo',sans-serif}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#fff7fb,#fff0f6);direction:rtl;color:#2b2b2b;padding:12px}
.container{max-width:980px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:12px;position:relative}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--rose-1),var(--rose-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px;box-shadow:var(--shadow)}
.title h1{margin:0;font-size:18px}
.title p{margin:0;font-size:13px;color:var(--muted)}

/* hearts floating */
.hearts{position:absolute;left:8px;top:4px;pointer-events:none}
.heart{width:18px;height:18px;transform:rotate(-45deg);position:absolute;animation:float 5s linear infinite;opacity:0.95}
.heart:before,.heart:after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:var(--rose-1)}
.heart:before{top:-9px;left:0}
.heart:after{left:9px;top:0}
.heart:nth-child(1){left:0;top:0;animation-delay:0s}
.heart:nth-child(2){left:30px;top:6px;animation-delay:1.2s;transform:scale(0.9) rotate(-45deg)}
.heart:nth-child(3){left:60px;top:2px;animation-delay:2.3s;transform:scale(0.8) rotate(-45deg)}
@keyframes float{0%{transform:translateY(0) rotate(-45deg) scale(1);opacity:0.95}50%{transform:translateY(-18px) rotate(-45deg) scale(1.05);opacity:1}100%{transform:translateY(0) rotate(-45deg) scale(1);opacity:0.95}}

/* actions */
.actions{display:flex;gap:8px;align-items:center}
.btn{background:var(--rose-1);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:0 6px 18px rgba(255,90,130,0.12)}
.btn.alt{background:var(--rose-2)}

/* pill showing amount only */
.pill{display:inline-block;padding:6px 12px;border-radius:999px;background:linear-gradient(90deg,var(--rose-1),#8ff0df);color:white;font-weight:900;box-shadow:0 8px 20px rgba(255,90,130,0.12);cursor:pointer}
/* negative pill style */
.pill.negative{background:linear-gradient(90deg,#ff2e4d,#a10012);color:white;text-shadow:0 1px 0 rgba(0,0,0,0.6);box-shadow:0 0 0 3px rgba(255,255,255,0.6), 0 0 0 6px rgba(0,0,0,0.25)}

/* card and table */
.card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow);margin-bottom:12px}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;text-align:center;border-bottom:1px dashed #fde7ef;font-size:14px}
.input{width:100%;padding:8px;border-radius:8px;border:1px solid #f6e6ee;text-align:center;font-size:14px;background:transparent}
.rowTotal{font-weight:800;color:#2b2b2b}

/* crossed style */
.crossed{opacity:0.45;text-decoration:line-through;color:#b18998}

/* currency visuals with colors per denom */
.currency-pile{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.coin{min-width:46px;height:46px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(180deg,#fff,#fff4f7);box-shadow:0 4px 10px rgba(0,0,0,0.06);color:#333;padding:6px}
.bill{min-width:72px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;background:linear-gradient(135deg,#fff,#fff6f8);box-shadow:0 4px 10px rgba(0,0,0,0.06);color:#333;padding:6px}

/* color classes for denominations */
.d200{background:var(--sea-blue);color:white}
.d100{background:var(--desert-yellow);color:#3b2b00}
.d50{background:var(--grass-green);color:white}
.d20{background:var(--rose-red);color:white}
.d10{background:var(--copper-orange);color:white}
.d5{background:linear-gradient(180deg,#eef2f6,#cfd6db);color:#333}
.d2{background:var(--gray);color:white}
.d1{background:var(--pale-gray);color:#333}
.d05{background:var(--antique-copper);color:white}

/* quick input */
.quick-row{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-wrap:wrap}
.quick-input{flex:1;padding:10px;border-radius:10px;border:1px dashed #ffd7e6;background:#fff;text-align:right;font-size:15px}

/* confirmation tick */
.tick{display:inline-block;margin-right:8px;color:green;font-weight:800;opacity:0;transform:translateY(-6px);transition:all .25s ease}

/* tips area */
.tips{margin-top:12px;padding:10px;border-radius:12px;background:linear-gradient(90deg,#fff,#fff6fb);box-shadow:0 6px 18px rgba(111,209,200,0.04);min-height:56px}
.tip-text{font-size:15px;color:#7a5160;font-weight:600}

/* footer area */
.footer-actions{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:12px;flex-wrap:wrap}
.save-area{display:flex;gap:8px;align-items:center}
.note{font-size:13px;color:var(--muted)}

/* responsive */
@media (max-width:720px){
  .header{flex-direction:column;align-items:flex-start;gap:10px}
  .table th,.table td{font-size:13px;padding:6px}
  .logo{width:48px;height:48px;font-size:16px}
  .actions{width:100%;justify-content:flex-start}
  .footer-actions{flex-direction:column;align-items:stretch}
  .hearts{left:6px;top:2px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</div>
      <div class="title">
        <h1>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª â€” ÙˆØ±Ø¯ÙŠ ğŸŒ¸</h1>
      </div>
    </div>

    <div class="hearts" aria-hidden>
      <div class="heart"></div><div class="heart"></div><div class="heart"></div>
    </div>

    <div class="actions">
      <div id="balancePill" class="pill" style="display:none;"></div>
      <button id="toggleBalanceBtn" class="btn">Ø§Ù„Ø±ØµÙŠØ¯</button>
      <button id="toggleChangeBtn" class="btn alt">Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚ÙˆØ¯</button>
      <button id="screenshotBtn" class="btn">Ù„Ù‚Ø·Ø©</button>
    </div>
  </div>

  <div class="card" id="mainCard">
    <div class="quick-row">
      <input id="quickEntry" class="quick-input" placeholder="Ø£Ø¯Ø®Ù„: 6 Ø´Ù…Ø§Ù… 5Ø´ Ø£Ùˆ Ø´Ù…Ø§Ù… 5Ø´ Ø«Ù… Ø§Ø¶ØºØ· Enter" autocomplete="off" />
      <button id="addQuickBtn" class="btn">Ø£Ø¯Ø®Ù„</button>
      <div id="confirmTick" class="tick">âœ… ØªÙ…</div>
    </div>

    <table class="table" role="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù">
      <thead>
        <tr>
          <th style="width:46%">Ø§Ù„ØµÙ†Ù</th>
          <th style="width:16%">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th style="width:18%">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© (â‚ª)</th>
          <th style="width:12%">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
          <th style="width:8%">Ø´Ø·Ø¨</th>
        </tr>
      </thead>
      <tbody id="itemsBody">
        <!-- rows injected only after quick entry -->
      </tbody>
    </table>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:12px;flex-wrap:wrap">
      <div style="min-width:200px">
        <div class="note">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø´Ø·ÙˆØ¨ÙŠÙ†): <b id="grandTotal">0.00</b> â‚ª</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="note">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„Ø±ØµÙŠØ¯" Ù„Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø²Ø¨ÙˆÙ† ÙˆØ£Ø¹Ø±Ø¶Ù‡ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©.</div>
      </div>
    </div>

    <div class="card" id="changeBox" style="margin-top:12px;display:none">
      <h4 style="margin:6px 0 8px 0">ÙØ¦Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø© â€” Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù†Ù‚ÙˆØ¯</h4>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div>Ø¥Ø±Ø¬Ø§Ø¹ Ù…ØªÙˆÙ‚Ø¹: <b id="changeAmount">0.00</b> â‚ª</div>
        <div class="currency-pile" id="changeVisual"></div>
      </div>
    </div>

    <div class="tips">
      <div id="tipText" class="tip-text">Ù…Ø±Ø­Ø¨Ù‹Ø§! Ù†ØµØ§Ø¦Ø­ Ù„Ø·ÙŠÙØ© Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† ğŸ’–</div>
    </div>
  </div>

  <div class="footer-actions">
    <div class="save-area">
      <button id="saveBtn" class="btn">Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      <button id="loadBtn" class="btn alt">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
      <button id="exportJSON" class="btn">ØªØµØ¯ÙŠØ± JSON</button>
      <button id="exportTXT" class="btn alt">ØªØµØ¯ÙŠØ± TXT</button>
    </div>
    <div class="note">Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø³ÙŠØ·Ø© ÙˆØ­Ø³Ø§Ø³Ø© â€” Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§ØªÙƒ Ø¨Ø³Ø±Ø¹Ø© â™¥</div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
// helpers and state
const el = (s)=>document.querySelector(s);
const elAll = (s)=>document.querySelectorAll(s);
const DENOMS = [200,100,50,20,10,5,2,1,0.5]; // ILS
let state = {items:[],paid:null,balanceVisible:false,freeze:false};

// tips array (30 tips)
const TIPS = [
"ÙƒÙ„ ØµØ¨Ø§Ø­ ÙŠØ¨Ø¯Ø£ Ø¨ØªØ±ØªÙŠØ¨ Ø¨Ø³ÙŠØ· â€” Ø¬Ù‡Ù‘Ø² Ù‚Ø§Ø¦Ù…Ø© Ù…Ø´ØªØ±ÙŠØ§Øª Ù‚ØµÙŠØ±Ø©.",
"Ø§Ø´ØªØ±ÙŠ Ù…Ø§ ØªØ­ØªØ§Ø¬ ÙÙ‚Ø· â€” ØªÙˆÙÙŠØ± Ø¨Ø³ÙŠØ· ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù‚Ù„ÙˆØ¨ ØªØ·ÙŠØ±.",
"Ù„Ø§Ø­Ù‚Ù‹Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙ†ÙŠÙ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø´Ø±Ø§Ø¡.",
"Ø¶Ø¹ÙŠ Ø¹Ù„Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„ØªÙƒØ±Ø§Ø±Ù‡Ø§ Ø¨Ø³Ø±Ø¹Ø©.",
"Ø¬Ø±Ù‘Ø¨ÙŠ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø¶Ø§Ø± Ø§Ù„Ù…ÙˆØ³Ù…ÙŠØ© â€” Ø£Ù„Ø° ÙˆØ£ÙˆÙØ±.",
"Ù„Ø§ ØªÙ†Ø³ÙŠ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ Ù„Ù„Ø­Ù„ÙˆÙ‰ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©.",
"Ù‚ÙˆÙ…ÙŠ Ø¨Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ â€” Ø°ÙƒÙŠØ© ÙˆÙ…ÙˆÙØ±Ø©.",
"ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ù„Ø© Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙˆØ²Ù† ÙŠØ³Ù‡Ù„ Ø­Ù…Ù„Ù‡Ø§.",
"Ø§ÙƒØªØ¨ÙŠ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø°Ù‡Ù†ÙŠ â€” Ø§Ù„Ø°Ø§ÙƒØ±Ø© ØªØ®ÙˆÙ† Ø£Ø­ÙŠØ§Ù†Ù‹Ø§.",
"Ø§Ø¨ØªØ³Ù…ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³ÙˆÙ‚ â€” Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ© ØªØ¬Ø°Ø¨ Ø§Ù„Ø£ÙØ¶Ù„.",
"Ø§Ø³ØªØ¨Ø¯Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø© Ø¨Ø¨Ø¯Ø§Ø¦Ù„ Ø£Ø®Ù Ù„Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù‚ØµÙŠØ±Ø©.",
"Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‡Ø¯Ø±.",
"Ø§Ø­Ø±ØµÙŠ Ø¹Ù„Ù‰ ÙØ­Øµ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø³Ø±ÙŠØ¹Ù‹Ø§.",
"Ø§Ø´ØªØ±ÙŠ Ø¨ÙƒÙ…ÙŠØ§Øª ØµØºÙŠØ±Ø© Ø¥Ù† Ù„Ù… ØªÙƒÙˆÙ†ÙŠ Ù…ØªØ£ÙƒØ¯Ø©.",
"Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ù…Ø³Ø¨Ù‚ Ù„Ù„ÙˆØ¬Ø¨Ø§Øª ÙŠÙˆÙØ± ÙˆÙ‚ØªÙƒ ÙˆØµØ­ØªÙƒ.",
"Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù†ØªØ¬Ø§Øª ØµØ¯ÙŠÙ‚Ø© Ù„Ù„Ø¨ÙŠØ¦Ø© Ø­ÙŠÙ†Ù…Ø§ ØªØ³ØªØ·ÙŠØ¹ÙŠÙ†.",
"Ù‚ÙŠÙ…ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø¨Ø¹ÙŠÙ† Ù†Ù‚Ø¯ÙŠØ© â€” Ù„ÙŠØ³Øª ÙƒÙ„ Ø®ØµÙ… ÙŠØ³ØªØ­Ù‚ Ø§Ù„Ø´Ø±Ø§Ø¡.",
"Ø§Ø­ÙØ¸ÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø§Øª Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©.",
"Ù‚Ø·Ù‘Ø¹ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø·ÙˆÙŠÙ„Ø© Ù„Ø±Ø­Ù„ØªÙŠÙ† Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† ÙˆØ§Ø­Ø¯Ø© Ù…Ø±Ù‡Ù‚Ø©.",
"Ø­Ø§ÙØ¸ÙŠ Ø¹Ù„Ù‰ Ø­Ù‚ÙŠØ¨Ø© ØªØ³ÙˆÙ‚ Ù‚Ø§Ø¨Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….",
"Ø§Ø´ØªØ±ÙŠ Ù…Ù† Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠÙŠÙ† Ù„Ø¯Ø¹Ù… Ø§Ù„Ù…Ø¬ØªÙ…Ø¹.",
"Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„ØµØºÙŠØ± ÙŠÙØ±Ø­ Ø¨Ø§Ù„Ù„ÙØªØ§Øª Ø§Ù„ØµØºÙŠØ±Ø© â€” Ø§Ø´ØªØ±ÙŠ Ø²Ù‡Ø±Ø©! ğŸŒ¹",
"Ø­Ø¶Ù‘Ø±ÙŠ ÙˆØ¬Ø¨Ø© Ø³Ø±ÙŠØ¹Ø© Ù…Ù† Ù…ÙƒÙˆÙ†Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ¨Ù‚Ù‰ Ù…Ø¨ØªØ³Ù…Ø©.",
"Ø§Ø¨ØªØ¹Ø¯ÙŠ Ø¹Ù† Ø§Ù„ØªØ³ÙˆÙ‚ Ø­ÙŠÙ† ØªÙƒÙˆÙ†ÙŠ Ø¬ÙˆØ¹Ø§Ù†Ø© â€” Ù…ØºØ§Ù…Ø±Ø© Ø®Ø·Ø£.",
"Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù†ØªØ¬Ø§Øª Ø°Ø§Øª ØªØºÙ„ÙŠÙ Ø£Ù‚Ù„ Ù„Ù„Ø¨ÙŠØ¦Ø©.",
"Ø§Ø­ØªÙØ¸ÙŠ Ø¨Ù‚Ù„Ù… ØµØºÙŠØ± ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù„ØªØ¯ÙˆÙŠÙ† Ø§Ù„Ø³Ø±ÙŠØ¹.",
"Ø§Ø³ØªÙ…ØªØ¹ÙŠ Ø¨ÙˆÙ‚ØªÙƒ â€” Ø§Ù„Ø´Ø±Ø§Ø¡ ØªØ¬Ø±Ø¨Ø©ØŒ Ø§Ø¬Ø¹Ù„ÙŠÙ‡Ø§ Ù„Ø·ÙŠÙØ©.",
"Ø§Ø¹Ù…Ù„ÙŠ Ù‚ÙˆØ§Ø¦Ù… Ø´Ù‡Ø±ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†Ø³ÙŠØ§Ù†.",
"ØªØ°ÙƒÙ‘Ø±ÙŠ: ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡ Ù‡ÙŠ Ø§Ø³ØªØ«Ù…Ø§Ø± ÙÙŠ ÙŠÙˆÙ…Ùƒ.",
"Ù‚ÙˆÙ…ÙŠ Ø¨Ù…ÙƒØ§ÙØ£Ø© Ù†ÙØ³Ùƒ Ø¨Ø¹Ù…Ù„ Ø¨Ø³ÙŠØ· Ø¨Ø¹Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ³ÙˆÙ‚."
];

function format(n){return Number(n||0).toFixed(2);}
function debounce(fn,ms){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),ms)}}

// parse quick input
function parseQuickInput(text){
  if(!text || !text.trim()) return null;
  text = text.replace(/\u200f/g,'').trim();
  text = text.replace(/ØŒ/g,',');
  const priceMatch = text.match(/(\d+(\.\d+)?)\s*Ø´\s*$/i) || text.match(/(\d+(\.\d+)?)\s*Ø´/i);
  let price = null;
  if(priceMatch){
    price = parseFloat(priceMatch[1]);
    text = text.substring(0, priceMatch.index).trim();
  } else {
    const nums = text.match(/(\d+(\.\d+)?)/g);
    if(nums && nums.length>0){
      price = parseFloat(nums[nums.length-1]);
      text = text.replace(new RegExp(nums[nums.length-1]+'\\s*$'),'').trim();
    }
  }
  const leadingMatch = text.match(/^\s*(\d+(\.\d+)?)\s+/);
  let qty = 1;
  if(leadingMatch){
    qty = parseFloat(leadingMatch[1]);
    text = text.substring(leadingMatch[0].length).trim();
  }
  let name = text.trim();
  if(!name) name = 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
  if(price===null || isNaN(price)) price = 0;
  return {name, qty, price};
}

// create row
function createRow(item={name:'',qty:1,price:0,excluded:false}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td style="text-align:right;padding-right:8px"><input class="input itemName" placeholder="Ù…Ø«Ø§Ù„: 6 Ø´Ù…Ø§Ù… 5Ø´" value="${escapeHtml(item.name)}" /></td>
    <td><input class="input itemQty" type="number" step="0.01" value="${item.qty}" /></td>
    <td><input class="input itemPrice" type="number" step="0.01" value="${item.price}" /></td>
    <td class="rowTotal">${format(item.qty*item.price)}</td>
    <td style="text-align:center"><input class="excludeChk" type="checkbox" ${item.excluded?'checked':''} title="Ø´Ø·Ø¨/Ø¥Ù„ØºØ§Ø¡ Ø§Ø­ØªØ³Ø§Ø¨"></td>
  `;
  const chk = tr.querySelector('.excludeChk');
  chk.addEventListener('change',()=>{ if(chk.checked){ tr.classList.add('crossed'); } else { tr.classList.remove('crossed'); } saveStateFromUI(); recalc(); });
  if(item.excluded) tr.classList.add('crossed');
  const qty = tr.querySelector('.itemQty');
  const price = tr.querySelector('.itemPrice');
  const name = tr.querySelector('.itemName');
  const upd = debounce(()=>{ tr.querySelector('.rowTotal').textContent = format((parseFloat(qty.value||0))*(parseFloat(price.value||0))); saveStateFromUI(); recalc(); },2000);
  qty.addEventListener('input',upd);
  price.addEventListener('input',upd);
  name.addEventListener('input',debounce(()=>{ saveStateFromUI(); },700));
  return tr;
}
function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function addRow(item){ const tr = createRow(item); el('#itemsBody').appendChild(tr); saveStateFromUI(); recalc(); }

// recalc totals
function recalc(){
  const rows = [...elAll('#itemsBody tr')];
  let total=0;
  rows.forEach(r=>{ if(!r.querySelector('.excludeChk').checked){ const q=parseFloat(r.querySelector('.itemQty').value||0); const p=parseFloat(r.querySelector('.itemPrice').value||0); total += q*p; } });
  el('#grandTotal').textContent = format(total);
  const paid = state.paid || 0;
  const change = Math.round((paid - total)*100)/100;
  el('#changeAmount').textContent = format(Math.abs(change));
  updateBalancePillVisual();
  if(el('#changeBox').style.display === 'block') calcChangeDenoms();
}

// save/load
function saveStateFromUI(){
  const rows = [...elAll('#itemsBody tr')];
  state.items = rows.map(r=>({ name: r.querySelector('.itemName').value, qty: parseFloat(r.querySelector('.itemQty').value||0), price: parseFloat(r.querySelector('.itemPrice').value||0), excluded: !!r.querySelector('.excludeChk').checked }));
  localStorage.setItem('basket_pink_final2', JSON.stringify(state));
}
function loadState(s){
  state = s || JSON.parse(localStorage.getItem('basket_pink_final2')||'null') || state;
  el('#itemsBody').innerHTML='';
  (state.items.length?state.items:[]).forEach(i=>addRow(i));
  recalc();
}

// change denom calc
function calcChangeDenoms(){
  const total = parseFloat(el('#grandTotal').textContent||0);
  const paid = state.paid || 0;
  let diff = Math.round((paid - total)*100)/100;
  const container = el('#changeVisual'); container.innerHTML='';
  if(diff <= 0){
    container.innerHTML = '<div class="note">Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù†Ù‚ÙˆØ¯</div>';
    return;
  }
  let rem = diff;
  const res = [];
  DENOMS.forEach(d=>{ const cnt = Math.floor(rem / d); if(cnt>0){ res.push({denom:d,count:cnt}); rem = Math.round((rem - cnt*d)*100)/100; } });
  res.forEach(r=>{
    const node = document.createElement('div');
    const cls = r.denom === 200 ? 'd200 bill' :
                r.denom === 100 ? 'd100 bill' :
                r.denom === 50 ? 'd50 bill' :
                r.denom === 20 ? 'd20 bill' :
                r.denom === 10 ? 'd10 bill' :
                r.denom === 5 ? 'd5 coin' :
                r.denom === 2 ? 'd2 coin' :
                r.denom === 1 ? 'd1 coin' : 'd05 coin';
    node.className = cls;
    node.textContent = `${r.denom}â‚ª Ã— ${r.count}`;
    container.appendChild(node);
  });
}

// handle balance click: prompt and set pill
function handleBalanceClick(){
  const v = prompt('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø¯ÙØ¹ Ø§Ù„Ø²Ø¨ÙˆÙ† (â‚ª):', state.paid==null?'':state.paid);
  if(v === null) return;
  const num = parseFloat(String(v).replace(',','.'));
  if(isNaN(num)){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­'); return; }
  state.paid = num;
  saveStateFromUI(); recalc();
}
function updateBalancePillVisual(){
  const pill = el('#balancePill');
  if(state.paid == null){ pill.style.display='none'; return; }
  const total = parseFloat(el('#grandTotal').textContent||0);
  const diff = Math.round((state.paid - total)*100)/100;
  if(diff < 0){
    pill.classList.add('negative');
    pill.style.display='inline-block';
    pill.textContent = '-' + format(Math.abs(diff)) + ' â‚ª';
  } else {
    pill.classList.remove('negative');
    pill.style.display='inline-block';
    pill.textContent = 'Ø§Ù„Ø±ØµÙŠØ¯: ' + format(state.paid) + ' â‚ª';
  }
}

// freeze inputs to avoid mobile jumping
function freezeInputs(duration=2000){
  state.freeze = true;
  document.querySelectorAll('.input, .quick-input, button').forEach(elm=>{ elm.disabled = true; });
  setTimeout(()=>{ document.querySelectorAll('.input, .quick-input, button').forEach(elm=>{ elm.disabled = false; }); state.freeze=false; }, duration);
}

// confirmation tick + sound
function confirmFeedback(){
  const tick = el('#confirmTick');
  tick.style.opacity = '1';
  tick.style.transform = 'translateY(0)';
  playBeep();
  setTimeout(()=>{ tick.style.opacity='0'; tick.style.transform='translateY(-6px)'; },900);
}
function playBeep(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = 'sine';
    o.frequency.value = 880;
    g.gain.value = 0.06;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); },180);
  }catch(e){ console.log('audio error', e); }
}

// quick submit
function handleQuickSubmit(){
  if(state.freeze) return;
  const txt = el('#quickEntry').value.trim();
  if(!txt) return;
  const parsed = parseQuickInput(txt);
  if(!parsed) return;
  addRow(parsed);
  el('#quickEntry').value='';
  freezeInputs(2000);
  setTimeout(()=>{ el('#quickEntry').focus(); },2100);
  confirmFeedback();
}

// tips rotation
let tipIndex = 0;
function rotateTips(){ tipIndex = (tipIndex+1) % TIPS.length; el('#tipText').textContent = TIPS[tipIndex]; }
el('#tipText').textContent = TIPS[Math.floor(Math.random()*TIPS.length)];
setInterval(rotateTips, 120000);

// bindings
el('#addQuickBtn').addEventListener('click', handleQuickSubmit);
el('#quickEntry').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); handleQuickSubmit(); } });
el('#toggleBalanceBtn').addEventListener('click', handleBalanceClick);
el('#balancePill').addEventListener('click', handleBalanceClick);
el('#toggleChangeBtn').addEventListener('click', ()=>{ const box = el('#changeBox'); box.style.display = (box.style.display === 'block') ? 'none' : 'block'; if(box.style.display === 'block') calcChangeDenoms(); });
el('#screenshotBtn').addEventListener('click', ()=>{ const node = document.getElementById('mainCard'); html2canvas(node,{scale:2}).then(canvas=>{ const a=document.createElement('a'); a.href = canvas.toDataURL('image/png'); a.download='basket_shot.png'; a.click(); }); });
el('#saveBtn').addEventListener('click', ()=>{ saveStateFromUI(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ø­Ù„ÙŠØ§Ù‹.'); });
el('#loadBtn').addEventListener('click', ()=>{ loadState(); alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© (Ø¥Ù† ÙˆÙØ¬Ø¯Øª).'); });
el('#exportJSON').addEventListener('click', ()=>{ saveStateFromUI(); const data = JSON.stringify(state, null, 2); const blob = new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='basket.json'; a.click(); });
el('#exportTXT').addEventListener('click', ()=>{ saveStateFromUI(); let txt='Ù‚Ø§Ø¦Ù…Ø© Ù…Ø´ØªØ±ÙŠØ§Øª\n=================\n'; state.items.forEach((it,i)=>{ txt+=`${i+1}. ${it.name} â€” ${it.qty} Ã— ${it.price} = ${(it.qty*it.price).toFixed(2)} â‚ª${it.excluded? ' (Ù…Ø´Ø·ÙˆØ¨)':''}\n`; }); txt+=`\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${el('#grandTotal').textContent} â‚ª\n`; const blob = new Blob([txt],{type:'text/plain'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='basket.txt'; a.click(); });

// initial: no rows until user input (load if exists)
if(localStorage.getItem('basket_pink_final2')){ loadState(); } else { el('#itemsBody').innerHTML = ''; recalc(); }

</script>
</body>
</html>
