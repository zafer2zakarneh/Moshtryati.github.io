

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>مشترياتي 🛒</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic&display=swap" rel="stylesheet">
  <style>
    /* ====== Base ====== */
    :root {
      --accent: #4674e7;
      --muted: #888;
      --bg: #fafafa;
      --card: #fff;
      --danger: #bd2e2e;
      --good: #207520;
    }
    * { box-sizing: border-box; }
    html,body { height: 100%; }
    body{
      margin:0; padding:14px;
      font-family: "Noto Naskh Arabic", serif;
      background: var(--bg);
      color:#222;
      font-size:18px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
    }

    /* ====== Header ====== */
    header {
      width:100%;
      max-width:760px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    h1 {
      margin:0;
      font-size:28px;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    #header-controls {
      display:flex;
      align-items:center;
      gap:10px;
    }
    button {
      cursor:pointer;
      border:1.4px solid #555;
      background:#fff;
      border-radius:8px;
      padding:6px 12px;
      font-size:18px;
      font-weight:600;
    }
    button:focus { outline: 3px solid rgba(70,116,231,0.15); }

    /* balance pill in header */
    #balance-pill {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid #ddd;
      min-width:140px;
      justify-content:center;
      font-weight:700;
      color:#333;
    }

    /* ====== Balance input area ====== */
    #balance-container {
      width:100%;
      max-width:760px;
      display:flex;
      gap:12px;
      align-items:center;
      margin:10px 0;
      justify-content:flex-start;
    }
    #balance-container.hidden { display:none; }
    #balance-label { font-weight:700; white-space:nowrap; }
    #balance-input {
      padding:8px 10px;
      font-size:18px;
      border-radius:8px;
      border:1.4px solid #aaa;
      width:200px;
      outline-offset:2px;
    }

    /* ====== Summary (top, under header) ====== */
    #summary {
      width:100%;
      max-width:760px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    #total-amount { font-size:22px; font-weight:800; }
    #balance-remaining {
      padding:6px 12px;
      border-radius:10px;
      min-width:180px;
      text-align:center;
      font-weight:800;
    }
    .rem-good { background:#d4f8d4; color:var(--good); }
    .rem-bad { background:#f8d4d4; color:var(--danger); }
    .rem-zero { background:#d0e6fb; color:#1a4e8c; }

    /* ====== Table ====== */
    .table-wrap {
      width:100%;
      max-width:760px;
    }
    table {
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px;
      background:transparent;
    }
    thead th {
      text-align:center;
      padding:8px;
      font-size:18px;
      border-bottom:2px solid #555;
    }
    tbody tr {
      background:var(--card);
      box-shadow:0 0 6px rgba(0,0,0,0.05);
      vertical-align:middle;
    }
    tbody tr.struck{
      text-decoration:line-through;
      color:var(--muted);
      background:#f2f2f2;
    }
    td { padding:8px; text-align:center; vertical-align:middle; font-size:17px; }
    .item-name { width:100%; text-align:right; padding:6px 8px; border-radius:8px; border:1.2px solid #ccc; }
    .qty, .price {
      padding:6px 8px; border-radius:8px; border:1.2px solid #ccc; width:100px; text-align:center;
    }
    .qty[readonly], .price[readonly] { background:#fafafa; color:#888; border-color:#ddd; }

    .strike-toggle {
      display:inline-block; width:28px; height:28px; border-radius:50%;
      border:2px solid #666; cursor:pointer; position:relative; user-select:none;
    }
    .strike-toggle.checked { background:var(--accent); border-color:var(--accent); }
    .strike-toggle.checked::after { content:'✔'; position:absolute; left:6px; top:1px; color:#fff; font-size:16px; }

    .total-cell { font-weight:800; min-width:100px; }

    /* footer controls */
    #controls-bottom {
      width:100%;
      max-width:760px;
      margin-top:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    #controls-bottom .left, #controls-bottom .right { display:flex; gap:8px; align-items:center; }

    /* Responsive */
    @media (max-width:600px) {
      body { padding:10px; font-size:16px; }
      .qty, .price { width:80px; }
      #balance-input { width:140px; }
      #balance-pill { min-width:120px; font-size:15px; }
    }
  </style>
</head>
<body>

<header>
  <h1>مشترياتي 🛒</h1>

  <div id="header-controls" aria-hidden="false">
    <div id="balance-pill" title="رصيد الزبون" style="display:none">الرصيد: <span id="balance-pill-value">0.00 ₪</span></div>
    <button id="toggle-balance-btn" aria-pressed="false" title="إظهار/إخفاء حقل الرصيد">+ رصيد</button>
    <button id="print-btn" title="طباعة الفاتورة">🖨️ طباعة</button>
  </div>
</header>

<!-- Balance input row -->
<div id="balance-container" class="hidden" role="region" aria-live="polite" aria-label="حقل الرصيد">
  <label id="balance-label" for="balance-input">رصيد الزبون:</label>
  <input id="balance-input" type="number" inputmode="decimal" step="0.01" min="0" placeholder="أدخل المبلغ" aria-describedby="balance-label" />
  <button id="apply-balance-btn" title="تطبيق الرصيد">تطبيق</button>
</div>

<!-- Summary -->
<div id="summary" role="status" aria-live="polite">
  <div id="total-amount">المجموع: 0.00 ₪</div>
  <div id="balance-remaining" aria-atomic="true"></div>
</div>

<!-- Items table -->
<div class="table-wrap">
  <table id="items-table" role="grid" aria-label="جدول المشتريات">
    <thead>
      <tr>
        <th>⭕</th>
        <th style="text-align:right">الصنف</th>
        <th>الكمية</th>
        <th>سعر الوحدة (₪)</th>
        <th>الإجمالي (₪)</th>
      </tr>
    </thead>
    <tbody id="rows-tbody" role="rowgroup"></tbody>
  </table>
</div>

<!-- Bottom controls -->
<div id="controls-bottom">
  <div class="left">
    <button id="add-row-btn" title="إضافة سطر">+ إضافة سطر</button>
    <button id="next-btn" title="التالي — انتقل للسطر التالي">التالي ▶</button>
  </div>
  <div class="right" aria-hidden="false">
    <button id="cleanup-btn" title="حذف السطور الفارغة">حذف الفارغات</button>
  </div>
</div>

<script>
/* ========= Clean, modular JS ========= */
/* Configuration */
const LOCK_DURATION_MS = 2000;      // قفل الحقول بعد التحليل (ms)
const INPUT_DEBOUNCE_MS = 2000;     // debounce عند التعديل اليدوي ل qty/price

/* عناصر DOM */
const rowsTbody = document.getElementById('rows-tbody');
const totalAmountEl = document.getElementById('total-amount');
const balanceRemainingEl = document.getElementById('balance-remaining');

const toggleBalanceBtn = document.getElementById('toggle-balance-btn');
const balanceContainer = document.getElementById('balance-container');
const balanceInput = document.getElementById('balance-input');
const applyBalanceBtn = document.getElementById('apply-balance-btn');
const balancePill = document.getElementById('balance-pill');
const balancePillValue = document.getElementById('balance-pill-value');

const printBtn = document.getElementById('print-btn');
const addRowBtn = document.getElementById('add-row-btn');
const nextBtn = document.getElementById('next-btn');
const cleanupBtn = document.getElementById('cleanup-btn');

/* State */
let balanceVisible = false;
let balanceValue = 0;
let balanceRemaining = 0;

/* Helper utilities */
function formatCurrency(v) {
  return Number(v).toFixed(2) + ' ₪';
}
function clampNumber(v, min = 0) {
  let n = parseFloat(v);
  if (isNaN(n) || n < min) return min;
  return n;
}

/* Parse input text like "6 شمام 5ش"  => qty=6, price=5, name=شمام */
function parseInputText(text) {
  const original = text.trim();
  if (!original) return { qty: 1, price: 0, name: '' };

  // price: find last occurrence of number followed by ش (e.g. 5ش) OR trailing number
  const priceMatchWithSh = [...original.matchAll(/(\d+(\.\d+)?)\s*ش/g)];
  let price = 0;
  let trailingNumberMatch = null;
  if (priceMatchWithSh.length) {
    price = parseFloat(priceMatchWithSh[priceMatchWithSh.length - 1][1]);
  } else {
    trailingNumberMatch = original.match(/(\d+(\.\d+)?)\s*$/);
    if (trailingNumberMatch) price = parseFloat(trailingNumberMatch[1]);
  }

  // qty: first number at start
  const qtyMatch = original.match(/^(\d+(\.\d+)?)/);
  let qty = 1;
  if (qtyMatch) qty = parseFloat(qtyMatch[1]);

  // name: remove qty at start and remove last price occurrence (if matched)
  let nameCandidate = original;
  if (qtyMatch) nameCandidate = nameCandidate.slice(qtyMatch[0].length).trim();

  if (priceMatchWithSh.length) {
    const lastSh = priceMatchWithSh[priceMatchWithSh.length - 1][0];
    const idx = nameCandidate.lastIndexOf(lastSh);
    if (idx !== -1) nameCandidate = (nameCandidate.slice(0, idx) + nameCandidate.slice(idx + lastSh.length)).trim();
  } else if (trailingNumberMatch) {
    nameCandidate = nameCandidate.slice(0, nameCandidate.length - trailingNumberMatch[0].length).trim();
  }

  if (!nameCandidate) nameCandidate = 'عنصر';

  return { qty, price, name: nameCandidate };
}

/* Create a single item row */
function createRow(initial = {}) {
  const tr = document.createElement('tr');
  tr.setAttribute('role', 'row');
  tr.dataset.struck = 'false';

  // strike cell
  const tdStrike = document.createElement('td');
  tdStrike.style.textAlign = 'center';
  const strikeBtn = document.createElement('span');
  strikeBtn.className = 'strike-toggle';
  strikeBtn.tabIndex = 0;
  strikeBtn.setAttribute('role','checkbox');
  strikeBtn.setAttribute('aria-checked','false');
  strikeBtn.title = 'شطب / إلغاء الشطب';
  tdStrike.appendChild(strikeBtn);

  // name
  const tdName = document.createElement('td');
  tdName.style.textAlign = 'right';
  const nameInput = document.createElement('input');
  nameInput.type = 'text';
  nameInput.className = 'item-name';
  nameInput.placeholder = 'أدخل اسم الصنف مع الكمية والسعر مثلا: 6 شمام 5ش';
  nameInput.autocomplete = 'off';
  nameInput.value = initial.rawInput || initial.name || '';
  tdName.appendChild(nameInput);

  // qty
  const tdQty = document.createElement('td');
  const qtyInput = document.createElement('input');
  qtyInput.type = 'number';
  qtyInput.className = 'qty';
  qtyInput.step = '0.01';
  qtyInput.min = '0';
  qtyInput.value = (initial.qty !== undefined) ? Number(initial.qty).toFixed(2) : '1.00';
  qtyInput.setAttribute('aria-label','الكمية');
  tdQty.appendChild(qtyInput);

  // price
  const tdPrice = document.createElement('td');
  const priceInput = document.createElement('input');
  priceInput.type = 'number';
  priceInput.className = 'price';
  priceInput.step = '0.01';
  priceInput.min = '0';
  priceInput.value = (initial.price !== undefined) ? Number(initial.price).toFixed(2) : '0.00';
  priceInput.setAttribute('aria-label','سعر الوحدة');
  tdPrice.appendChild(priceInput);

  // total
  const tdTotal = document.createElement('td');
  tdTotal.className = 'total-cell';
  tdTotal.textContent = '0.00';

  tr.appendChild(tdStrike);
  tr.appendChild(tdName);
  tr.appendChild(tdQty);
  tr.appendChild(tdPrice);
  tr.appendChild(tdTotal);

  /* Row state: timeouts */
  let lockTimer = null;
  let inputDebounce = null;

  /* Update row total */
  function updateRowTotal() {
    const qty = clampNumber(qtyInput.value, 0);
    const price = clampNumber(priceInput.value, 0);
    const total = qty * price;
    tdTotal.textContent = total.toFixed(2);
    updateTotals();
  }

  /* Lock/unlock qty & price */
  function setLocked(locked) {
    qtyInput.readOnly = locked;
    priceInput.readOnly = locked;
    if (locked) {
      qtyInput.classList.add('readonly');
      priceInput.classList.add('readonly');
      qtyInput.style.color = '#888';
      priceInput.style.color = '#888';
    } else {
      qtyInput.style.color = '';
      priceInput.style.color = '';
    }
  }

  /* Apply parse from name input */
  function applyParseFromName() {
    const parsed = parseInputText(nameInput.value);
    if (parsed.name) nameInput.value = parsed.name;
    qtyInput.value = Number(parsed.qty || 1).toFixed(2);
    priceInput.value = Number(parsed.price || 0).toFixed(2);
    setLocked(true);
    updateRowTotal();

    // clear existing timers
    clearTimeout(lockTimer);
    lockTimer = setTimeout(() => {
      setLocked(false);
      qtyInput.focus();
    }, LOCK_DURATION_MS);
  }

  /* Name keyboard handling:
     - Enter -> parse + add new row
     - Space (double-space) -> parse (single space also triggers parse)
     We'll implement: single space -> parse, double-space quickly -> parse + add new row
  */
  let lastSpaceTime = 0;
  const DOUBLE_SPACE_THRESHOLD = 600; // ms

  nameInput.addEventListener('keydown', (e) => {
    if (e.isComposing) return;
    if (e.key === 'Enter') {
      e.preventDefault();
      applyParseFromName();
      insertRowAfter(tr);
    } else if (e.key === ' ') {
      const cursorEnd = nameInput.selectionStart === nameInput.value.length && nameInput.selectionEnd === nameInput.value.length;
      if (!cursorEnd) return;
      const now = Date.now();
      if (now - lastSpaceTime <= DOUBLE_SPACE_THRESHOLD) {
        // double space
        e.preventDefault();
        applyParseFromName();
        insertRowAfter(tr);
        lastSpaceTime = 0;
      } else {
        // single space: parse but stay in same input
        e.preventDefault();
        applyParseFromName();
        lastSpaceTime = now;
      }
    }
  });

  // Manual edits to qty/price -> immediate update + debounce finalization after INPUT_DEBOUNCE_MS
  function onQtyPriceInput() {
    // immediate clamp to numeric value but do not force format until debounce
    let q = parseFloat(qtyInput.value);
    if (isNaN(q) || q < 0) q = 0;
    let p = parseFloat(priceInput.value);
    if (isNaN(p) || p < 0) p = 0;
    // update total quickly
    tdTotal.textContent = (q * p).toFixed(2);
    updateTotals();

    // debounce to finalize formatting
    clearTimeout(inputDebounce);
    inputDebounce = setTimeout(() => {
      qtyInput.value = q.toFixed(2);
      priceInput.value = p.toFixed(2);
      tdTotal.textContent = (q * p).toFixed(2);
      updateTotals();
    }, INPUT_DEBOUNCE_MS);
  }

  qtyInput.addEventListener('input', onQtyPriceInput);
  priceInput.addEventListener('input', onQtyPriceInput);

  // Strike toggling
  function updateStrikeVisual() {
    if (tr.dataset.struck === 'true') {
      tr.classList.add('struck');
      strikeBtn.classList.add('checked');
      strikeBtn.setAttribute('aria-checked','true');
    } else {
      tr.classList.remove('struck');
      strikeBtn.classList.remove('checked');
      strikeBtn.setAttribute('aria-checked','false');
    }
  }
  strikeBtn.addEventListener('click', () => {
    tr.dataset.struck = tr.dataset.struck === 'true' ? 'false' : 'true';
    updateStrikeVisual();
    updateTotals();
  });
  strikeBtn.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      strikeBtn.click();
    }
  });

  // when name lost focus and was raw input, try parsing once
  nameInput.addEventListener('blur', () => {
    if (nameInput.value.trim()) {
      // if user typed an initial combined string, parse it
      applyParseFromName();
    }
  });

  // initial total
  updateRowTotal();
  updateStrikeVisual();

  return tr;
}

/* Insert new row after given row (or at end if null) */
function insertRowAfter(refRow) {
  const newRow = createRow();
  if (refRow && refRow.parentElement) {
    refRow.parentElement.insertBefore(newRow, refRow.nextSibling);
  } else {
    rowsTbody.appendChild(newRow);
  }
  // focus its name input
  const input = newRow.querySelector('.item-name');
  if (input) input.focus();
  updateTotals();
}

/* Update overall totals and balance remainder */
function updateTotals() {
  let sum = 0;
  for (const r of Array.from(rowsTbody.children)) {
    if (r.dataset.struck === 'true') continue;
    const totalCell = r.querySelector('.total-cell');
    if (!totalCell) continue;
    let v = parseFloat(totalCell.textContent);
    if (!isNaN(v)) sum += v;
  }
  totalAmountEl.textContent = `المجموع: ${sum.toFixed(2)} ₪`;

  // balance display
  if (balanceVisible && !isNaN(balanceValue)) {
    balanceRemaining = balanceValue - sum;
    if (balanceRemaining > 0.005) {
      balanceRemainingEl.className = 'rem-good';
      balanceRemainingEl.textContent = `الباقي: ${balanceRemaining.toFixed(2)} ₪`;
    } else if (balanceRemaining < -0.005) {
      balanceRemainingEl.className = 'rem-bad';
      balanceRemainingEl.textContent = `عليه دين: ${Math.abs(balanceRemaining).toFixed(2)} ₪`;
    } else {
      balanceRemainingEl.className = 'rem-zero';
      balanceRemainingEl.textContent = '✔️ لا رصيد متبقي';
    }
  } else {
    balanceRemainingEl.className = '';
    balanceRemainingEl.textContent = '';
  }
}

/* Check if row is empty */
function isRowEmpty(row) {
  const name = row.querySelector('.item-name').value.trim();
  const qty = parseFloat(row.querySelector('.qty').value) || 0;
  const price = parseFloat(row.querySelector('.price').value) || 0;
  return !name && qty <= 0 && price <= 0;
}

/* Cleanup empty rows (remove them) */
function cleanupEmptyRows() {
  for (let i = rowsTbody.children.length - 1; i >= 0; i--) {
    const r = rowsTbody.children[i];
    if (isRowEmpty(r)) rowsTbody.removeChild(r);
  }
  // keep at least one row
  if (!rowsTbody.children.length) rowsTbody.appendChild(createRow());
  updateTotals();
}

/* Find next row (after current focused element) else add a new row */
function focusNextRow() {
  const active = document.activeElement;
  let currentRow = active ? active.closest('tr') : null;
  if (!currentRow) {
    // focus first row name
    const first = rowsTbody.querySelector('.item-name');
    if (first) first.focus();
    return;
  }
  let next = currentRow.nextElementSibling;
  if (!next) {
    insertRowAfter(currentRow);
    next = currentRow.nextElementSibling;
  }
  const nameInput = next.querySelector('.item-name');
  if (nameInput) nameInput.focus();
}

/* ====== Events ====== */

/* Toggle balance area visibility */
toggleBalanceBtn.addEventListener('click', () => {
  balanceVisible = !balanceVisible;
  toggleBalanceBtn.setAttribute('aria-pressed', String(balanceVisible));
  balanceContainer.classList.toggle('hidden', !balanceVisible);
  if (balanceVisible) {
    balanceInput.focus();
    // show pill only if value > 0
    if (balanceValue > 0) {
      balancePill.style.display = 'inline-flex';
      balancePillValue.textContent = balanceValue.toFixed(2) + ' ₪';
    }
  } else {
    // hide pill and reset values
    balancePill.style.display = 'none';
    balanceInput.value = '';
    balanceValue = 0;
    updateTotals();
  }
});

/* Apply balance button (or Enter) */
applyBalanceBtn.addEventListener('click', () => {
  let val = parseFloat(balanceInput.value);
  if (isNaN(val) || val < 0) val = 0;
  balanceValue = val;
  balancePillValue.textContent = balanceValue.toFixed(2) + ' ₪';
  balancePill.style.display = 'inline-flex';
  updateTotals();
});
balanceInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    applyBalanceBtn.click();
  }
});

/* Print */
printBtn.addEventListener('click', () => {
  const win = window.open('', '_blank', 'width=700,height=800');
  if (!win) {
    alert('يرجى السماح بفتح النوافذ المنبثقة لطباعة الفاتورة.');
    return;
  }

  // compose rows HTML
  const rowsHtml = Array.from(rowsTbody.children)
    .filter(r => r.dataset.struck !== 'true')
    .map(r => {
      const name = (r.querySelector('.item-name').value || 'عنصر').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const qty = clampNumber(r.querySelector('.qty').value || 0);
      const price = clampNumber(r.querySelector('.price').value || 0);
      const total = (qty * price).toFixed(2);
      return `<tr><td>${name}</td><td style="text-align:center">${qty.toFixed(2)}</td><td style="text-align:center">${price.toFixed(2)}</td><td style="text-align:center">${total}</td></tr>`;
    }).join('\n');

  // compute totals
  const sum = Array.from(rowsTbody.children)
    .filter(r => r.dataset.struck !== 'true')
    .reduce((acc, r) => acc + (parseFloat(r.querySelector('.total-cell').textContent) || 0), 0);

  const rem = (balanceVisible && !isNaN(balanceValue)) ? (balanceValue - sum) : null;

  const doc = `<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>فاتورة مشترياتي</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Noto Naskh Arabic', serif; margin:20px; color:#000; direction:rtl; }
  h2 { border-bottom:2px solid #333; padding-bottom:8px; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th,td { border:1px solid #000; padding:8px; text-align:center; }
  th { background:#eee; font-weight:700; }
  .summary { font-weight:800; margin-top:10px; text-align:left; }
  .balance-positive { color:${getComputedStyle(document.documentElement).getPropertyValue('--good') || '#207520'}; }
  .balance-negative { color:${getComputedStyle(document.documentElement).getPropertyValue('--danger') || '#bd2e2e'}; }
</style>
</head>
<body>
  <h2>فاتورة مشترياتي 🛒</h2>
  <table>
    <thead><tr><th>الصنف</th><th>الكمية</th><th>سعر الوحدة (₪)</th><th>الإجمالي (₪)</th></tr></thead>
    <tbody>
      ${rowsHtml}
    </tbody>
  </table>
  <div class="summary">المجموع: ${sum.toFixed(2)} ₪</div>
  ${ rem !== null ? `<div class="summary">رصيد الزبون: ${balanceValue.toFixed(2)} ₪</div>
    <div class="summary ${rem > 0 ? 'balance-positive' : rem < 0 ? 'balance-negative' : ''}">الباقي: ${rem > 0 ? rem.toFixed(2) : rem < 0 ? '(' + Math.abs(rem).toFixed(2) + ')' : '0.00'} ₪</div>` : '' }
  <footer style="margin-top:22px; color:#666; text-align:center;">تم الطباعة بواسطة مشترياتي 🛒</footer>
<script>
  window.onload = function(){ window.print(); setTimeout(function(){ window.close(); }, 250); };
<\/script>
</body>
</html>`;

  win.document.open();
  win.document.write(doc);
  win.document.close();
});

/* Add row button */
addRowBtn.addEventListener('click', () => {
  rowsTbody.appendChild(createRow());
});

/* Next button */
nextBtn.addEventListener('click', () => {
  focusNextRow();
});

/* Cleanup */
cleanupBtn.addEventListener('click', () => cleanupEmptyRows());

/* Initialize with one row */
rowsTbody.appendChild(createRow());

/* Keep totals reactive via MutationObserver (for rows added/removed) */
const mo = new MutationObserver(() => updateTotals());
mo.observe(rowsTbody, { childList: true, subtree: true });

/* Also recalc periodically in case some fields changed outside events */
setInterval(() => updateTotals(), 1000);

</script>
</body>
</html>