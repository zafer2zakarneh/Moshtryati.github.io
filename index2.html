<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>مشترياتي 🛒</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Noto Naskh Arabic', serif; direction: rtl; text-align: center; background: #f9f9f9; margin:0; padding:20px; }
  h2 { margin: 10px; font-size: 26px; }
  .topBar { width: 90%; margin: 0 auto 12px auto; display:flex; justify-content:flex-end; gap:12px; align-items:center; }
  .box { min-width:80px; padding:8px 10px; border-radius:8px; background:#fff; box-shadow:0 0 6px rgba(0,0,0,0.08); border:1px solid #e6e6e6; font-size:14px; }
  .balanceTop { font-weight:700; padding:8px 12px; border-radius:8px; background:#fff; box-shadow:0 0 6px rgba(0,0,0,0.08); border:1px solid #e6e6e6; min-width:120px; text-align:center;}
  table { width: 90%; margin: 10px auto 30px auto; border-collapse: collapse; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 16px; }
  th { background-color: #f1f1f1; }
  tfoot td { font-weight: bold; background: #fafafa; }
  input.itemInput { width: 95%; padding: 5px; font-size: 15px; font-family: inherit; text-align: center; box-sizing: border-box; }
  button { padding: 6px 14px; margin: 10px; font-size: 15px; border: none; border-radius: 5px; cursor: pointer; }
  .btn { background: #007AFF; color: white; }
  .btn:hover { background: #005BB5; }
  .strike td { text-decoration: line-through; color: gray; }
  .strike input { text-decoration: line-through; color: gray; }
  .toggleBtn { cursor: pointer; font-size: 18px; user-select:none; }
  .total { min-width:80px; }
  @media print {
    .topBar, .btn { display:none !important; }
  }
</style>
</head>
<body>

<h2>مشترياتي 🛒</h2>

<!-- شريط علوي يظهر بعد ادخال الرصيد: صندوقان + رصيد -->
<div id="topBoxes" class="topBar" style="display:none;">
  <div class="box">صندوق 2</div>
  <div class="box">صندوق 1</div>
  <div id="balanceTop" class="balanceTop">الرصيد: 0.00 ش</div>
</div>

<div style="margin-bottom:8px;">
  <button class="btn" onclick="addBalance()">+ رصيد</button>
  <button class="btn" onclick="window.print()">🖨️ طباعة الفاتورة</button>
</div>

<table id="billTable">
  <thead>
    <tr>
      <th>✔️</th>
      <th>الصنف</th>
      <th>الكمية</th>
      <th>سعر الوحدة (ش)</th>
      <th>الإجمالي (ش)</th>
    </tr>
  </thead>
  <tbody id="billBody">
    <tr>
      <td class="toggleBtn" onclick="toggleStrike(this)">⭕</td>
      <td><input type="text" class="itemInput" placeholder="مثال: 6 شمام 5ش" onkeydown="handleEnter(event,this)"></td>
      <td><input type="number" class="itemInput qtyInput" value="0" disabled></td>
      <td><input type="number" class="itemInput priceInput" value="0" step="0.01" disabled></td>
      <td class="total">0.00</td>
    </tr>
  </tbody>
  <tfoot>
    <tr id="balanceRow" style="display:none;">
      <td colspan="4">الرصيد المتبقي</td>
      <td id="balanceValue">0.00</td>
    </tr>
    <tr>
      <td colspan="4">المجموع الكلي</td>
      <td id="grandTotal">0.00</td>
    </tr>
  </tfoot>
</table>

<script>
let customerBalance = null;
let lastSpaceTime = 0;

// نستخدم debounce 2 ثانية لتحديث الصف بعد التعديل اليدوي على الكمية أو السعر
const DEBOUNCE_MS = 2000;

// عند انشاء الصف/الصف الأول نضيف مستمعي حدث للحقلين qty و price
function attachInputListeners(row){
  const qtyInput = row.querySelector(".qtyInput");
  const priceInput = row.querySelector(".priceInput");

  function scheduleUpdate(){
    // حفظ المؤقت على العنصر نفسه
    if(row._updateTimer) clearTimeout(row._updateTimer);
    row._updateTimer = setTimeout(()=>{
      recomputeRowFromInputs(row);
      updateGrandTotal();
      row._updateTimer = null;
    }, DEBOUNCE_MS);
  }

  // عند الكتابة نؤجل التحديث
  qtyInput.addEventListener("input", scheduleUpdate);
  priceInput.addEventListener("input", scheduleUpdate);
}

// تعيد حساب إجمالي الصف اعتماداً على المدخلات اليدوية
function recomputeRowFromInputs(row){
  const qty = parseFloat(row.querySelector(".qtyInput").value) || 0;
  const price = parseFloat(row.querySelector(".priceInput").value) || 0;
  const totalCell = row.querySelector(".total");
  const newTotal = qty * price;
  totalCell.textContent = newTotal.toFixed(2);
}

// عند الضغط Enter أو Space: تفكيك النص
function handleEnter(e, input){
  if(e.key === "Enter" || e.key === " "){
    let now = Date.now();
    if(e.key === " "){
      if(now - lastSpaceTime < 500){ // ضغطتين Space => اضف صف
        parseItem(input);
        addRow();
      } else {
        parseItem(input); // ضغطة وحدة = حساب فقط
      }
      lastSpaceTime = now;
    } else if(e.key === "Enter"){
      parseItem(input);
      addRow();
    }
    e.preventDefault();
  }
}

function parseItem(input){
  let text = input.value.trim();
  let row = input.closest("tr");
  let cells = row.querySelectorAll("td");

  let qty = 1, price = 0, name = text;

  let qtyMatch = text.match(/^(\d+)\s+/);
  if(qtyMatch){ qty = parseFloat(qtyMatch[1]); name = text.replace(qtyMatch[0],''); }

  let priceMatch = text.match(/([\d\.]+)\s*ش/);
  if(priceMatch){ price = parseFloat(priceMatch[1]); name = name.replace(priceMatch[0],''); }

  // اسم الصنف
  cells[1].querySelector("input").value = name.trim();
  let qtyInput = cells[2].querySelector("input");
  let priceInput = cells[3].querySelector("input");

  qtyInput.value = qty;
  priceInput.value = price.toFixed(2);

  let total = qty * price;
  cells[4].textContent = total.toFixed(2);

  // قفل الحقول ثانيتين ثم فتحها (كما كنت تريد)
  qtyInput.disabled = true;
  priceInput.disabled = true;
  setTimeout(()=>{
    qtyInput.disabled = false;
    priceInput.disabled = false;
  },2000);

  // تأكد من أن لديه مستمعي الإدخال (مرة واحدة)
  attachInputListeners(row);

  updateGrandTotal();
}

function addRow(){
  let tbody = document.getElementById("billBody");
  let newRow = document.createElement("tr");
  newRow.innerHTML = `
    <td class="toggleBtn" onclick="toggleStrike(this)">⭕</td>
    <td><input type="text" class="itemInput" placeholder="اكتب صنف..." onkeydown="handleEnter(event,this)"></td>
    <td><input type="number" class="itemInput qtyInput" value="0" disabled></td>
    <td><input type="number" class="itemInput priceInput" value="0" step="0.01" disabled></td>
    <td class="total">0.00</td>
  `;
  tbody.appendChild(newRow);

  // ربط مستمعي الإدخال للصف الجديد
  attachInputListeners(newRow);

  // فوكس لحقل النص الجديد
  newRow.querySelector("input[type=text]").focus();
}

function toggleStrike(btn){
  let row = btn.closest("tr");
  row.classList.toggle("strike");
  updateGrandTotal();
}

function updateGrandTotal(){
  let rows = document.querySelectorAll("#billBody tr");
  let sum = 0;
  rows.forEach(r=>{
    if(!r.classList.contains("strike")){
      sum += parseFloat(r.querySelector(".total").textContent) || 0;
    }
  });
  document.getElementById("grandTotal").textContent = sum.toFixed(2);

  // إذا كان هناك رصيد زبون حساب الباقي وتحديث العرض العلوي
  if(customerBalance !== null){
    let remain = customerBalance - sum;
    let balanceCell = document.getElementById("balanceValue");
    let balanceTopCell = document.getElementById("balanceTop");

    balanceCell.textContent = remain.toFixed(2);
    balanceCell.style.color = remain >= 0 ? "green" : "red";

    // تحديث أعلى الصفحة
    balanceTopCell.textContent = `الرصيد: ${customerBalance.toFixed(2)} ش — المتبقي: ${remain.toFixed(2)} ش`;
    balanceTopCell.style.color = remain >= 0 ? "green" : "red";

    if(remain === 0){ balanceCell.textContent += " ✔️"; }
  }
}

function addBalance(){
  let amount = prompt("أدخل رصيد الزبون (شيكل):");
  if(amount !== null && amount !== "" && !isNaN(amount)){
    customerBalance = parseFloat(amount);
    // إظهار سطر الرصيد في Footer
    document.getElementById("balanceRow").style.display = "table-row";
    // إظهار شريط أعلى الصفحة فيه صندوقان + قيمة الرصيد
    document.getElementById("topBoxes").style.display = "flex";
    // إعداد القيمة العلوية فوراً
    document.getElementById("balanceTop").textContent = `الرصيد: ${customerBalance.toFixed(2)} ش`;
    updateGrandTotal();
  }
}

// عند التحميل: ربط مستمعي الحقل الأول
document.addEventListener("DOMContentLoaded", ()=>{
  const firstRow = document.querySelector("#billBody tr");
  attachInputListeners(firstRow);
});
</script>

</body>
</html>